// ================== Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù… ==================

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø¦Ù…
const STORAGE_CONFIG = {
    // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
    KEYS: {
        USER_DATA: 'userData_permanent',
        USER_BACKUP_1: 'userData_backup_1',
        USER_BACKUP_2: 'userData_backup_2',
        USER_BACKUP_3: 'userData_backup_3',
        LAST_SAVE: 'lastSaveTime'
    },
    // ÙØªØ±Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©)
    AUTO_SAVE_INTERVAL: 30000,
    // Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    BACKUP_COUNT: 3
};

// Ù…ØªØºÙŠØ± Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ by Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
let currentUserData = null;
let autoSaveInterval = null;

// ================== Ø¯ÙˆØ§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø¦Ù… ==================

/**
 * Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙÙ‚Ø¯Ø§Ù†Ù‡Ø§
 */
function savePermanentData(userData) {
    try {
        const dataToSave = {
            ...userData,
            lastSaved: new Date().toISOString(),
            version: '1.0'
        };
        
        const jsonData = JSON.stringify(dataToSave);
        
        // 1. Ø­ÙØ¸ ÙÙŠ localStorage (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)
        localStorage.setItem(STORAGE_CONFIG.KEYS.USER_DATA, jsonData);
        
        // 2. Ø­ÙØ¸ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø©
        localStorage.setItem(STORAGE_CONFIG.KEYS.USER_BACKUP_1, jsonData);
        localStorage.setItem(STORAGE_CONFIG.KEYS.USER_BACKUP_2, jsonData);
        localStorage.setItem(STORAGE_CONFIG.KEYS.USER_BACKUP_3, jsonData);
        
        // 3. Ø­ÙØ¸ ÙˆÙ‚Øª Ø¢Ø®Ø± Ø­ÙØ¸
        localStorage.setItem(STORAGE_CONFIG.KEYS.LAST_SAVE, Date.now().toString());
        
        // 4. Ø­ÙØ¸ ÙÙŠ sessionStorage ÙƒÙ†Ø³Ø®Ø© Ø¥Ø¶Ø§ÙÙŠØ©
        sessionStorage.setItem(STORAGE_CONFIG.KEYS.USER_DATA, jsonData);
        
        // 5. Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        currentUserData = { ...dataToSave };
        
        // 6. Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ ÙÙŠ IndexedDB (Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ ØªØ¯Ø¹Ù…Ù‡)
        saveToIndexedDB(dataToSave);
        
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹');
        return true;
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        return false;
    }
}

/**
 * Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø£ÙØ¶Ù„ Ù…ØµØ¯Ø± Ù…ØªØ§Ø­
 */
function loadPermanentData() {
    try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
        const sources = [
            () => localStorage.getItem(STORAGE_CONFIG.KEYS.USER_DATA),
            () => localStorage.getItem(STORAGE_CONFIG.KEYS.USER_BACKUP_1),
            () => localStorage.getItem(STORAGE_CONFIG.KEYS.USER_BACKUP_2),
            () => localStorage.getItem(STORAGE_CONFIG.KEYS.USER_BACKUP_3),
            () => sessionStorage.getItem(STORAGE_CONFIG.KEYS.USER_DATA),
            () => currentUserData ? JSON.stringify(currentUserData) : null
        ];
        
        for (const source of sources) {
            try {
                const data = source();
                if (data) {
                    const parsedData = JSON.parse(data);
                    if (parsedData && parsedData.email) {
                        console.log('âœ… ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                        // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©
                        savePermanentData(parsedData);
                        return parsedData;
                    }
                }
            } catch (parseError) {
                console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø£Ø­Ø¯ Ø§Ù„Ù…ØµØ§Ø¯Ø±:', parseError);
                continue;
            }
        }
        
        console.log('â„¹ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©');
        return null;
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        return null;
    }
}

/**
 * Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ IndexedDB Ù„Ù„Ø­ÙØ¸ Ø·ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¯Ù‰
 */
function saveToIndexedDB(userData) {
    if (!window.indexedDB) {
        console.log('IndexedDB ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
        return;
    }
    
    const request = indexedDB.open('UserDataDB', 1);
    
    request.onerror = function() {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ IndexedDB');
    };
    
    request.onsuccess = function(event) {
        const db = event.target.result;
        const transaction = db.transaction(['userData'], 'readwrite');
        const store = transaction.objectStore('userData');
        
        const data = {
            id: 'currentUser',
            ...userData,
            indexedDBSaved: new Date().toISOString()
        };
        
        store.put(data);
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ IndexedDB');
    };
    
    request.onupgradeneeded = function(event) {
        const db = event.target.result;
        const store = db.createObjectStore('userData', { keyPath: 'id' });
        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª IndexedDB');
    };
}

/**
 * Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† IndexedDB
 */
function loadFromIndexedDB() {
    return new Promise((resolve) => {
        if (!window.indexedDB) {
            resolve(null);
            return;
        }
        
        const request = indexedDB.open('UserDataDB', 1);
        
        request.onerror = function() {
            resolve(null);
        };
        
        request.onsuccess = function(event) {
            const db = event.target.result;
            const transaction = db.transaction(['userData'], 'readonly');
            const store = transaction.objectStore('userData');
            const getRequest = store.get('currentUser');
            
            getRequest.onsuccess = function() {
                resolve(getRequest.result);
            };
            
            getRequest.onerror = function() {
                resolve(null);
            };
        };
        
        request.onupgradeneeded = function() {
            resolve(null);
        };
    });
}

/**
 * Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
 */
function startAutoSave() {
    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø³Ø§Ø¨Ù‚
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    autoSaveInterval = setInterval(() => {
        if (currentUserData) {
            savePermanentData(currentUserData);
            console.log('ğŸ”„ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
    }, STORAGE_CONFIG.AUTO_SAVE_INTERVAL);
    
    console.log('âœ… ØªÙ… Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
}

/**
 * Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
 */
function protectDataOnUnload() {
    window.addEventListener('beforeunload', function(event) {
        if (currentUserData) {
            // Ø­ÙØ¸ Ù†Ù‡Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
            savePermanentData(currentUserData);
            console.log('ğŸ’¾ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©');
        }
    });
    
    // Ø­ÙØ¸ Ø¥Ø¶Ø§ÙÙŠ Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ²
    window.addEventListener('blur', function() {
        if (currentUserData) {
            savePermanentData(currentUserData);
        }
    });
    
    // Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && currentUserData) {
            savePermanentData(currentUserData);
        }
    });
}

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
 */
function validateSavedData() {
    const data = loadPermanentData();
    if (data && data.email && data.name) {
        console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø³Ù„ÙŠÙ…Ø©');
        return true;
    }
    console.log('âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© Ø£Ùˆ ØªØ§Ù„ÙØ©');
    return false;
}

// ================== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ ==================

function logineCallback(response) {
    const decoded = jwt_decode(response.credential);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
    const existingData = loadPermanentData();
    if (existingData && existingData.email === decoded.email) {
        console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯à¤®');
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
        showWelcomeSection(existingData.name);
        displayUserData(existingData);
        currentUserData = existingData;
        startAutoSave();
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    const overlay = document.getElementById("overlay");
    const phoneForm = document.createElement("div");
    phoneForm.innerHTML = `
        <div class="login-start2" >
            <div class="logine-img"><img src="login.png" alt="" style="width: 100%;"></div>
            <h3>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</h3>
            <input type="tel" id="userPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" maxlength="11" inputmode="numeric">
            <button id="submitPhone">ØªØ³Ø¬ÙŠÙ„</button>
            <div id="phoneError" class="error-message" style="display: none; color: red; margin-top: 10px; text-align: center;"></div>
            <h2> Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ­Ù…ÙŠ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ùˆ ØªØ·Ø¨Ù‚ Ø¹Ù„ÙŠÙ‡ <span><a href="Privacy.html" target="_blank">Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ùˆ Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a></span> Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒØ´Ù…ÙŠØ± Ù‡ÙˆÙ…</h2>
        </div>
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ù€ overlay
    overlay.innerHTML = "";
    overlay.appendChild(phoneForm);
    overlay.style.display = "flex";
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    document.getElementById("userPhone").addEventListener("input", function(e) {
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±
        if (this.value.length > 0 && this.value[0] !== '0') {
            this.value = '0' + this.value.replace(/^0+/, '');
        }
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø£Ù‚ØµÙ‰
        if (this.value.length > 11) {
            this.value = this.value.slice(0, 11);
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        const phoneError = document.getElementById("phoneError");
        if (phoneError) {
            phoneError.style.display = "none";
        }
    });
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    document.getElementById("submitPhone").addEventListener("click", async function() {
        const phoneInput = document.getElementById("userPhone");
        const phoneError = document.getElementById("phoneError");
        const phoneNumber = phoneInput.value.trim();
        
        // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø£ÙˆÙ„Ø§Ù‹
        phoneError.style.display = "none";
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø±ÙˆØ·
        if (!phoneNumber) {
            showPhoneError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
            return;
        }
        
        if (phoneNumber.length !== 11) {
            showPhoneError("ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† 11 Ø±Ù‚Ù…Ù‹Ø§");
            return;
        }
        
        if (phoneNumber[0] !== '0') {
            showPhoneError("ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø§Ù„Ø±Ù‚Ù… 0");
            return;
        }
        
        if (!/^01[0125][0-9]{8}$/.test(phoneNumber)) {
            showPhoneError("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­");
            return;
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
        showPhoneLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");

        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„ØªÙ„ÙŠÙÙˆÙ†
            const duplicateCheck = await checkDuplicateUser(decoded.email, phoneNumber);
            
            if (duplicateCheck.emailExists && duplicateCheck.phoneExists) {
                showPhoneError("Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù† Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø®ØªÙ„ÙÙŠÙ†.");
                return;
            } else if (duplicateCheck.emailExists) {
                showPhoneError("Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¢Ø®Ø±.");
                return;
            } else if (duplicateCheck.phoneExists) {
                showPhoneError("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‡Ø°Ø§ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø¢Ø®Ø±.");
                return;
            }

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªÙƒØ±Ø§Ø±ØŒ ØªØ§Ø¨Ø¹ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            showPhoneLoading("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
            const userData = {
                name: decoded.given_name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                family: decoded.family_name || "",
                email: decoded.email || "",
                phone: phoneNumber,
                registered: true,
                copon1: "",
                copon2: "",
                registrationDate: new Date().toISOString()
            };

            const formData = new FormData();
            formData.append("Nameo", userData.name);
            formData.append("FamilyName", userData.family);
            formData.append("Emailo", userData.email);
            formData.append("Phone", userData.phone);
            formData.append("Passwordo", "google");
            formData.append("copon1", "");
            formData.append("copon2", "");

            let googleSheetsSuccess = false;
            let jsonBinSuccess = false;

            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Google Sheets
                const googleResponse = await sendToGoogleSheets(formData);
                
                if (googleResponse.result === "success") {
                    googleSheetsSuccess = true;
                    console.log('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Google Sheets Ø¨Ù†Ø¬Ø§Ø­');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Google Sheets:', error);
            }

            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ JSONBin
                jsonBinSuccess = await sendToJSONBin(userData);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSONBin:', error);
            }

            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù… (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø£Ù‡Ù…!)
            const saveSuccess = savePermanentData(userData);
            
            if (saveSuccess) {
                currentUserData = userData;
                startAutoSave(); // Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                showPhoneSuccess("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…!");
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            if (googleSheetsSuccess && jsonBinSuccess) {
                showPhoneSuccess("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª!");
            } else if (googleSheetsSuccess || jsonBinSuccess) {
                const platforms = [];
                if (googleSheetsSuccess) platforms.push("Google Sheets");
                if (jsonBinSuccess) platforms.push("JSONBin");
                showPhoneWarning(`ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ: ${platforms.join(', ')}`);
            } else if (saveSuccess) {
                showPhoneSuccess("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­!");
            } else {
                showPhoneError("ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                return;
            }

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ù…Ø¹ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            setTimeout(() => {
                // Ø­ÙØ¸ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒØ¯
                savePermanentData(userData);
                
                showWelcomeSection(userData.name);
                displayUserData(userData);
                overlay.style.display = "none";
                
                // Ø¥Ø²Ø§Ù„Ø© Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù…Ù† Ø§Ù„ØµÙØ­Ø©
                document.body.style.overflow = "auto";
                document.documentElement.style.overflow = "auto";
                
                // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± person1 Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                const person1Element = document.getElementById("registerSection");
                if (person1Element) {
                    person1Element.remove();
                    console.log('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± person1');
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ù„Ø© ÙÙˆØ±Ø§Ù‹
                reactivateCartButtons();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø£Ø·ÙˆÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                setTimeout(() => {
                    // Ø­ÙØ¸ Ù†Ù‡Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    savePermanentData(userData);
                    window.location.reload();
                }, 4000);
                
            }, 1500);

        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', error);
            showPhoneError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }
    });
    
    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ø§Ø¦Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    function showPhoneError(message) {
        const phoneError = document.getElementById("phoneError");
        phoneError.textContent = message;
        phoneError.style.cssText = `
            display: block;
            color: red;
            margin: 10px 0;
            text-align: center;
            padding: 10px;
            background-color: #fee;
            border: 1px solid #fcc;
            border-radius: 5px;
        `;
    }

    function showPhoneSuccess(message) {
        const phoneError = document.getElementById("phoneError");
        phoneError.textContent = message;
        phoneError.style.cssText = `
            display: block;
            color: green;
            margin: 10px 0;
            text-align: center;
            padding: 10px;
            background-color: #efe;
            border: 1px solid #cfc;
            border-radius: 5px;
        `;
    }

    function showPhoneWarning(message) {
        const phoneError = document.getElementById("phoneError");
        phoneError.textContent = message;
        phoneError.style.cssText = `
            display: block;
            color: orange;
            margin: 10px 0;
            text-align: center;
            padding: 10px;
            background-color: #ffeaa7;
            border: 1px solid #fdcb6e;
            border-radius: 5px;
        `;
    }

    function showPhoneLoading(message) {
        const phoneError = document.getElementById("phoneError");
        phoneError.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center;">
                <div style="width: 20px; height: 20px; border: 2px solid #2196f3; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px;"></div>
                ${message}
            </div>
        `;
        phoneError.style.cssText = `
            display: block;
            color: blue;
            margin: 10px 0;
            text-align: center;
            padding: 10px;
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
        `;
        
        // Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if (!document.getElementById('phone-loading-styles')) {
            const style = document.createElement('style');
            style.id = 'phone-loading-styles';
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }
    }
}

// ================== Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ© ==================

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ù„Ø©
function reactivateCartButtons() {
    console.log('Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ù„Ø©...');
    
    // ØªØ·Ø¨ÙŠÙ‚ ØªÙØ¹ÙŠÙ„ ÙÙˆØ±ÙŠ Ø£ÙˆÙ„Ø§Ù‹
    activateButtons();
    
    // Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø¨Ø¹Ø¯ 100ms
    setTimeout(() => {
        activateButtons();
    }, 100);
    
    // ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 300ms Ù„Ù„ØªØ£ÙƒØ¯
    setTimeout(() => {
        activateButtons();
    }, 300);
    
    // ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ 500ms
    setTimeout(() => {
        activateButtons();
        console.log('ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ù„Ø©');
    }, 500);
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
function activateButtons() {
    const cartButtons = document.querySelectorAll('.btn_add_cart');
    console.log(`ØªÙØ¹ÙŠÙ„ ${cartButtons.length} Ø²Ø± Ø³Ù„Ø©`);
    
    cartButtons.forEach((button, index) => {
        // Ø¥Ø²Ø§Ù„Ø© event listeners Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Ø¥Ø¶Ø§ÙØ© event listener Ø¬Ø¯ÙŠØ¯
        newButton.addEventListener('click', handleCartClick);
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø²Ø± Ù†Ø´Ø·
        newButton.disabled = false;
        newButton.style.pointerEvents = 'auto';
        newButton.style.opacity = '1';
        newButton.style.cursor = 'pointer';
        newButton.style.userSelect = 'none';
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± hover
        newButton.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
        });
        
        newButton.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
        
        console.log(`âœ“ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø³Ù„Ø© ${index + 1} - Ø§Ù„Ù…Ù†ØªØ¬: ${newButton.getAttribute('data-id')}`);
    });
    
    // Ø¥Ø·Ù„Ø§Ù‚ Ø­Ø¯Ø« Ø§Ù„ØªÙØ¹ÙŠÙ„
    const cartActivatedEvent = new CustomEvent('cartButtonsActivated', {
        detail: { 
            buttonCount: cartButtons.length,
            timestamp: Date.now()
        }
    });
    document.dispatchEvent(cartActivatedEvent);
}

// Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ù„Ø©
function handleCartClick(event) {
    // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    event.preventDefault();
    event.stopPropagation();
    
    console.log('ğŸ›’ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø³Ù„Ø©');
    
    const button = event.target.closest('.btn_add_cart');
    if (!button) {
        console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø³Ù„Ø©');
        return;
    }
    
    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…ØªÙƒØ±Ø±
    button.style.pointerEvents = 'none';
    
    const productId = button.getAttribute('data-id');
    const isActive = button.classList.contains('active');
    
    console.log(`ğŸ“¦ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬: ${productId}, ÙÙŠ Ø§Ù„Ø³Ù„Ø©: ${isActive}`);
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ø¯Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø³Ù„Ø©ØŒ Ø§Ø³ØªØ¯Ø¹Ù‡Ø§ Ù‡Ù†Ø§
    if (typeof addToCart === 'function') {
        addToCart(productId, button);
    } else if (typeof handleAddToCart === 'function') {
        handleAddToCart(productId, button);
    } else if (typeof toggleCart === 'function') {
        toggleCart(productId, button);
    } else {
        // ÙƒÙˆØ¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø©
        console.log('ğŸ”„ ØªÙ†ÙÙŠØ° Ø¥Ø¶Ø§ÙØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø³Ù„Ø©');
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ ÙÙˆØ±ÙŠ
        button.style.transform = 'scale(0.95)';
        
        setTimeout(() => {
            if (isActive) {
                // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø©
                button.classList.remove('active');
                button.innerHTML = '<i class="fa-solid fa-cart-plus"></i> Ø§Ø¶Ù Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ø©';
                console.log('â– ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©');
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
                button.classList.add('active');
                button.innerHTML = '<i class="fa-solid fa-cart-plus"></i> ØªÙ… Ø§Ø¶Ø§ÙØ© Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ø©';
                console.log('â• ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø©');
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
            button.style.transform = 'scale(1)';
            button.style.pointerEvents = 'auto';
            
            // Ø¥Ø·Ù„Ø§Ù‚ Ø­Ø¯Ø« Ù…Ø®ØµØµ Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ù„Ø©
            const cartChangeEvent = new CustomEvent('cartChanged', {
                detail: { 
                    productId: productId, 
                    added: !isActive,
                    button: button,
                    timestamp: Date.now()
                }
            });
            document.dispatchEvent(cartChangeEvent);
            
        }, 150);
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø£Ù…Ø§Ù†
    setTimeout(() => {
        button.style.pointerEvents = 'auto';
    }, 1000);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Google Sheets Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø©
async function sendToGoogleSheets(formData) {
    const scriptURL = "https://script.google.com/macros/s/AKfycbzDPcLwO1U091L_W1Ha-M-_GjL5z6V7aFh6RxTberNq8tsYLIkkI1BtdF5ufA8qpSmvag/exec";
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // Ù…Ù‡Ù„Ø© Ø²Ù…Ù†ÙŠØ© 10 Ø«ÙˆØ§Ù†Ù

    try {
        const response = await fetch(scriptURL, {
            method: "POST",
            body: formData,
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
    } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
            throw new Error('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ø·Ù„Ø¨');
        }
        throw error;
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSONBin
async function sendToJSONBin(userData) {
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª JSONBin
    const JSONBIN_CONFIG = {
        API_KEY: "$2a$10$xAWjC3zelpDKCd6zdOdUg.D0bwtEURjcR5sEiYdonjBmP5lHuqzq2",
        BIN_ID: "6848177e8960c979a5a77f85",
        BASE_URL: "https://api.jsonbin.io/v3"
    };

    try {
        // Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/b/${JSONBIN_CONFIG.BIN_ID}/latest`, {
            method: 'GET',
            headers: {
                'X-Master-Key': JSONBIN_CONFIG.API_KEY,
                'Content-Type': 'application/json'
            }
        });

        let existingData = [];
        if (response.ok) {
            const result = await response.json();
            existingData = Array.isArray(result.record) ? result.record : [];
        }

        // Ø£Ø¶Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ ÙˆØªØ§Ø±ÙŠØ®
        const newEntry = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            ...userData
        };
        
        existingData.push(newEntry);

        // Ø§Ø±Ø³Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        const updateResponse = await fetch(`${JSONBIN_CONFIG.BASE_URL}/b/${JSONBIN_CONFIG.BIN_ID}`, {
            method: 'PUT',
            headers: {
                'X-Master-Key': JSONBIN_CONFIG.API_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(existingData)
        });

        if (updateResponse.ok) {
            console.log('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSONBin Ø¨Ù†Ø¬Ø§Ø­');
            return true;
        } else {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSONBin');
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSONBin:', error);
        return false;
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„ØªÙ„ÙŠÙÙˆÙ† ÙÙŠ JSONBin
async function checkDuplicateUser(email, phone) {
    const JSONBIN_CONFIG = {
        API_KEY: "$2a$10$xAWjC3zelpDKCd6zdOdUg.D0bwtEURjcR5sEiYdonjBmP5lHuqzq2",
        BIN_ID: "6848177e8960c979a5a77f85",
        BASE_URL: "https://api.jsonbin.io/v3"
    };

    try {
        const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/b/${JSONBIN_CONFIG.BIN_ID}/latest`, {
            method: 'GET',
            headers: {
                'X-Master-Key': JSONBIN_CONFIG.API_KEY,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            const existingData = Array.isArray(result.record) ? result.record : [];
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ ØªÙ„ÙŠÙÙˆÙ† Ù…ÙƒØ±Ø±
            const duplicateEmail = existingData.find(user => user.email === email);
            const duplicatePhone = existingData.find(user => user.phone === phone);
            
            return {
                emailExists: !!duplicateEmail,
                phoneExists: !!duplicatePhone,
                duplicateEmail: duplicateEmail,
                duplicatePhone: duplicatePhone
            };
        }
        return {
            emailExists: false,
            phoneExists: false,
            duplicateEmail: null,
            duplicatePhone: null
        };
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±:', error);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„ØªØ¬Ù†Ø¨ Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ÙŠØ§Ù‹
        return {
            emailExists: false,
            phoneExists: false,
            duplicateEmail: null,
            duplicatePhone: null
        };
    }
}

// ================== Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ==================

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
 */
function showSavedData() {
    const data = loadPermanentData();
    if (data) {
        console.log('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', data);
        console.log('ğŸ“… ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø­ÙØ¸:', data.lastSaved);
        console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ù„ÙŠÙ…Ø© ÙˆÙ…ØªØ§Ø­Ø©');
    } else {
        console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©');
    }
}

/**
 * Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø­Ø°Ø±!)
 */
function clearAllSavedData() {
    const confirmed = confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!');
    if (confirmed) {
        // Ø­Ø°Ù Ù…Ù† localStorage
        Object.values(STORAGE_CONFIG.KEYS).forEach(key => {
            localStorage.removeItem(key);
        });
        
        // Ø­Ø°Ù Ù…Ù† sessionStorage
        sessionStorage.removeItem(STORAGE_CONFIG.KEYS.USER_DATA);
        
        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        currentUserData = null;
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
            autoSaveInterval = null;
        }
        
        console.log('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
        alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    }
}

/**
 * Ø¯Ø§Ù„Ø© Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
 */
function exportSavedData() {
    const data = loadPermanentData();
    if (data) {
        const dataBlob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `user_data_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log('ğŸ“¥ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    } else {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
    }
}

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù
 */
function importSavedData(fileInput) {
    const file = fileInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.email && importedData.name) {
                    savePermanentData(importedData);
                    currentUserData = importedData;
                    console.log('ğŸ“¤ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                    alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    alert('Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        };
        reader.readAsText(file);
    }
}

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸
 */
function getStorageStatus() {
    const status = {
        localStorage: {
            available: !!window.localStorage,
            dataExists: !!localStorage.getItem(STORAGE_CONFIG.KEYS.USER_DATA),
            backups: {
                backup1: !!localStorage.getItem(STORAGE_CONFIG.KEYS.USER_BACKUP_1),
                backup2: !!localStorage.getItem(STORAGE_CONFIG.KEYS.USER_BACKUP_2),
                backup3: !!localStorage.getItem(STORAGE_CONFIG.KEYS.USER_BACKUP_3)
            }
        },
        sessionStorage: {
            available: !!window.sessionStorage,
            dataExists: !!sessionStorage.getItem(STORAGE_CONFIG.KEYS.USER_DATA)
        },
        indexedDB: {
            available: !!window.indexedDB
        },
        memoryStorage: {
            dataExists: !!currentUserData
        },
        autoSave: {
            active: !!autoSaveInterval,
            lastSave: localStorage.getItem(STORAGE_CONFIG.KEYS.LAST_SAVE)
        }
    };
    
    console.log('ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸:', status);
    return status;
}

// ================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ==================

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø¦Ù…');
    
    // ØªÙØ¹ÙŠÙ„ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    protectDataOnUnload();
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    const savedData = loadPermanentData();
    if (savedData) {
        currentUserData = savedData;
        console.log('âœ… ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', savedData.name, savedData.email);
        
        // Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        startAutoSave();
        
        // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø© Ù‡Ù†Ø§
        // Ù…Ø«Ù„: showWelcomeSection(savedData.name);
    }
    
    // Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
    getStorageStatus();
    
    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø¦Ù… Ø¨Ù†Ø¬Ø§Ø­');
});

// Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ù„ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ù‡Ù„ Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.userDataManager = {
    save: savePermanentData,
    load: loadPermanentData,
    show: showSavedData,
    clear: clearAllSavedData,
    export: exportSavedData,
    import: importSavedData,
    status: getStorageStatus,
    current: () => currentUserData
};

console.log('ğŸ”§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… window.userDataManager Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…');
